<head>
<meta charset="UTF-8">
<meta name="description" content="Manage borrower requests">
<meta name="robots" content="noodp">
</head>

<div class="col-xs-12" style="padding-bottom:1%;">
  <h4>
    <% if Rails.env != "test" %>
        <%="Lend away, #{@signup_parent.email}!"%>
    <% end %>
  </h4>

  <h5 style="font-size:90%; font-style:italic">
    Click to 
    <%= link_to "lend more stuff", new_inventory_path, { style: 'color:#428bca; display: inline-block', class: "btn-inline"}%>
    or to
    <%= link_to 'borrow something', new_request_path, { style: 'color:#428bca'}%>
  </h5>

  <p>In the table below, you'll be able to manage your items:</p>

  <ul>
    <li><b>Column 1:</b> cool thanks for sharing this!
    <li><b>Column 2:</b> add or change links or descriptions to help you keep track of who has what</li>
    <li><b>Column 3:</b> click YES or NO to manage requests; if you accept, we'll connect you via email with the borrower. If you have more than one outstanding request for one item, choose whomever!
    <li><b>Column 4:</b> click REMOVE to delete an item; click UNAVAILABLE to mark it temporarily unavailable (e.g., if you're going away). When you return, please click AVAILABLE so our borrowers can see it again! Note, you can only do this after clearing your outstanding requests</li>
  </ul>

</div>
<%= render "layouts/flash" %>

<div class="table-responsive">
  <table class="table table-condensed table-hover">
    <thead>
      <tr>
        <th class="col-xs-1">Item</th>
        <th class="col-xs-3">Description</th>
        <th class="col-xs-7">Dates of Request & Message</th>
        <th class="col-xs-1">Actions</th>
      </tr>
    </thead>

    <tbody>
      <% @inventories.each do |inventory| %>
        <tr>
          <td>
            <% if inventory.available == false %>
              <%= "<span id='name_#{inventory.id}'>#{Itemlist.find_by_id(inventory.itemlist_id).name}</span> <br> <span style='color:red;', id='not_available_#{inventory.id}'>Unavailable</span>".html_safe %>
            <% else %>
              <%= "<span id='name_#{inventory.id}'>#{Itemlist.find_by_id(inventory.itemlist_id).name}</span>".html_safe %>
            <% end %>
          </td>
          <td>
            <% if inventory.description.blank? %>
              <%= form_for inventory, url: edit_inventory_path(inventory), method: :patch, :html => {:class => "form-inline", :autocomplete => "off"} do |f| %> 
                <div class="form-group col-xs-10" style="padding:1px;">
                  <%= f.text_field :description, class: "form-control", id: "inventory_description_#{inventory.id}", placeholder: "Add a link or description" %>
                </div>
                <div class="form-group col-xs-2" style="padding:1px;">
                  <%= f.submit "Add", class: "btn btn-default btn-default btn-block", id: "add_description_#{inventory.id}"%>
                </div>
              <% end %>
            <% else %>
              <%= "<span id='description_#{inventory.id}'>#{inventory.description}. #{link_to 'CHANGE', destroy_description_path(inventory), method: :patch, id: "update_description_#{inventory.id}"}</span>".html_safe %>

            <% end %>
          </td>
          <td>
            <% if Borrow.find_by_inventory_id(inventory.id).present? %>
              <table class="table table-condensed">
                <thead>
                  <tr>
                    <th class="col-xs-1"></th>
                    <th class="col-xs-9"></th>
                    <th class="col-xs-2"></th>
                  </tr>
                </thead>
                <% @total_borrows = Borrow.where(inventory_id: inventory.id, status1: [1,2,3]).includes(:request).order('requests.pickupdate')%>
                <% @total_borrows.each do |borrow| %>
                  <% if borrow.request.pickupdate.present? && borrow.request.returndate.present? %> 
                    <tbody>
                      <tr>
                        <td><%= "#{borrow.request.pickupdate.strftime("%-m/%-d")} to #{borrow.request.returndate.strftime("%-m/%-d")}" %> </td>

                        <% case borrow.status1 %>
                        <% when 3 %>
                          <td id="in_progress"><%= "Thanks, we've connected you with #{borrow.request.signup.email} via email." %></td>
                        <% when 2 %>
                          <td id="connected"><%= "Thanks, we've connected you with #{borrow.request.signup.email} via email." %></td>
                        <% when 1 %>
                          <td id="manage_text"><%= "New request from #{borrow.request.signup.email} in #{Geography.find_by_zipcode(borrow.request.signup.zipcode).city}! #{borrow.request.detail}" %></td>
                          <td id="manage"><%= 
                          "#{button_to 'YES', lender_accept_url(borrow), method: :post, id: "accept #{borrow.id}", style: "background-color:green; color: white; width: 40px; display: inline"} 
                          #{button_to 'NO', lender_decline_url(borrow), method: :post, id: "decline #{borrow.id}", style: "background-color:gray; width: 40px; display: inline"}".html_safe %></td>
                        <% else %>
                        <% end %>
                      </tr>
                    </tbody>
                  <% end %>
                <% end %>
              </table>
            <% end %>
          </td>
          <td>
            <ul>
            <!-- next step, define time period of unavailability, but then what happens if a user has multiple time periods to define at once? best way to achieve latter woudl probably be to submit a self-use request -->
                <% if Borrow.where(inventory_id: inventory.id).select { |b| (b.request.pickupdate.present?) && (b.request.returndate.present?) && ((b.request.pickupdate > Date.today) || (b.request.returndate > Date.today)) }.count == 0 %>
                  <li>
                    <%= link_to "#{inventory.available == true ? 'UNAVAILABLE' : 'AVAILABLE'}", toggle_available_path(inventory), method: :patch, id: "toggle_#{inventory.id}" %>
                  </li>
                  <li>
                    <%= link_to 'REMOVE', inventory, method: :delete, id: "remove_#{inventory.id}", data: { confirm: "Are you sure this item is no longer up for sharing?" } %>
                  </li>
                <% end %>
            </ul>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
